from WindPy import w

import warnings


def wind_api_decorator(func):
    def wrapper(*args, **kwargs):
        w.start()

        if not w.isconnected():
            raise RuntimeError('Wind API not connected.')

        wind_result = func(*args, **kwargs)

        if type(wind_result) == w.WindData:
            err_code = wind_result.ErrorCode

            if err_code == -40522007:
                raise ValueError("Field index not supported.")
            elif err_code == -40522017:
                warnings.warn("Request data off WindPy limit.")
            elif err_code != 0:
                raise RuntimeWarning("Wind API request error.")

        return wind_result
    return wrapper


@wind_api_decorator
def stock_basic_series(codes, fields, begin=None, end=None, day='Trading',
                       period='D', priceadj='', options="", usedf=False, *args, **kwargs):
    opts = options.split(';')
    if day != 'D' and 'Days' not in options:
        opts.append(f"Days={day}")
    if period != 'D' and 'period' not in options:
        opts.append(f"Period={period}")
    if priceadj and 'PriceAdj' not in options:
        opts.append(f"PriceAdj={priceadj}")
    options = ';'.join(opts)

    return w.wsd(codes, fields, beginTime=begin, endTime=end, options=options, usedf=usedf, *args, **kwargs)


if __name__ == '__main__':
    # s = stock_basic_series("010107.SH", "mkt_cap_float", "2019-01-01", "2019-10-10")
    s = stock_basic_series("000001.SZ", "mkt_freeshares", "2019-10-01", "2019-12-31")
    pass
# w.wsd("000001.SZ,000002.SZ,000008.SZ,000009.SZ,000012.SZ,000021.SZ,000027.SZ,000028.SZ,000031.SZ,000039.SZ,000046.SZ,000050.SZ,000060.SZ,000061.SZ,000062.SZ,000063.SZ,000066.SZ,000069.SZ,000078.SZ,000089.SZ,000090.SZ,000100.SZ,000156.SZ,000157.SZ,000158.SZ,000166.SZ,000301.SZ,000333.SZ,000338.SZ,000400.SZ,000401.SZ,000402.SZ,000415.SZ,000425.SZ,000488.SZ,000501.SZ,000513.SZ,000519.SZ,000528.SZ,000537.SZ,000538.SZ,000540.SZ,000543.SZ,000547.SZ,000553.SZ,000559.SZ,000563.SZ,000564.SZ,000568.SZ,000581.SZ,000596.SZ,000598.SZ,000600.SZ,000623.SZ,000625.SZ,000627.SZ,000629.SZ,000630.SZ,000636.SZ,000651.SZ,000656.SZ,000661.SZ,000671.SZ,000681.SZ,000685.SZ,000686.SZ,000690.SZ,000703.SZ,000708.SZ,000709.SZ,000717.SZ,000718.SZ,000723.SZ,000725.SZ,000728.SZ,000729.SZ,000732.SZ,000738.SZ,000739.SZ,000750.SZ,000758.SZ,000768.SZ,000776.SZ,000778.SZ,000783.SZ,000786.SZ,000807.SZ,000813.SZ,000825.SZ,000826.SZ,000830.SZ,000858.SZ,000860.SZ,000869.SZ,000876.SZ,000877.SZ,000878.SZ,000883.SZ,000887.SZ,000895.SZ,000898.SZ,000930.SZ,000932.SZ,000937.SZ,000938.SZ,000959.SZ,000960.SZ,000961.SZ,000963.SZ,000967.SZ,000970.SZ,000975.SZ,000977.SZ,000983.SZ,000988.SZ,000990.SZ,000997.SZ,000998.SZ,000999.SZ,001872.SZ,001914.SZ,001979.SZ,002001.SZ,002002.SZ,002004.SZ,002007.SZ,002008.SZ,002010.SZ,002013.SZ,002019.SZ,002024.SZ,002027.SZ,002028.SZ,002030.SZ,002032.SZ,002038.SZ,002044.SZ,002048.SZ,002049.SZ,002050.SZ,002051.SZ,002056.SZ,002064.SZ,002074.SZ,002075.SZ,002078.SZ,002080.SZ,002081.SZ,002085.SZ,002092.SZ,002093.SZ,002110.SZ,002120.SZ,002124.SZ,002128.SZ,002129.SZ,002131.SZ,002138.SZ,002142.SZ,002146.SZ,002152.SZ,002153.SZ,002155.SZ,002156.SZ,002157.SZ,002174.SZ,002179.SZ,002183.SZ,002185.SZ,002191.SZ,002195.SZ,002202.SZ,002203.SZ,002212.SZ,002217.SZ,002221.SZ,002223.SZ,002230.SZ,002233.SZ,002236.SZ,002241.SZ,002242.SZ,002244.SZ,002249.SZ,002250.SZ,002252.SZ,002266.SZ,002268.SZ,002271.SZ,002273.SZ,002281.SZ,002294.SZ,002299.SZ,002302.SZ,002304.SZ,002311.SZ,002317.SZ,002340.SZ,002352.SZ,002353.SZ,002368.SZ,002371.SZ,002372.SZ,002373.SZ,002375.SZ,002382.SZ,002384.SZ,002385.SZ,002387.SZ,002390.SZ,002396.SZ,002399.SZ,002408.SZ,002410.SZ,002414.SZ,002415.SZ,002416.SZ,002419.SZ,002422.SZ,002423.SZ,002424.SZ,002429.SZ,002434.SZ,002440.SZ,002444.SZ,002456.SZ,002458.SZ,002460.SZ,002463.SZ,002465.SZ,002468.SZ,002475.SZ,002493.SZ,002500.SZ,002503.SZ,002505.SZ,002506.SZ,002507.SZ,002508.SZ,002511.SZ,002544.SZ,002555.SZ,002557.SZ,002558.SZ,002563.SZ,002568.SZ,002572.SZ,002583.SZ,002589.SZ,002594.SZ,002595.SZ,002600.SZ,002601.SZ,002602.SZ,002603.SZ,002607.SZ,002624.SZ,002625.SZ,002635.SZ,002640.SZ,002648.SZ,002653.SZ,002670.SZ,002673.SZ,002683.SZ,002690.SZ,002701.SZ,002705.SZ,002709.SZ,002714.SZ,002736.SZ,002739.SZ,002745.SZ,002773.SZ,002791.SZ,002797.SZ,002807.SZ,002812.SZ,002815.SZ,002818.SZ,002821.SZ,002831.SZ,002839.SZ,002841.SZ,002867.SZ,002901.SZ,002916.SZ,002920.SZ,002925.SZ,002926.SZ,002936.SZ,002938.SZ,002939.SZ,002941.SZ,002945.SZ,002946.SZ,002948.SZ,002957.SZ,002958.SZ,002966.SZ,002985.SZ,003816.SZ,300001.SZ,300002.SZ,300003.SZ,300009.SZ,300010.SZ,300012.SZ,300014.SZ,300015.SZ,300017.SZ,300024.SZ,300026.SZ,300033.SZ,300058.SZ,300059.SZ,300070.SZ,300072.SZ,300088.SZ,300113.SZ,300115.SZ,300122.SZ,300124.SZ,300133.SZ,300134.SZ,300136.SZ,300142.SZ,300144.SZ,300146.SZ,300166.SZ,300168.SZ,300180.SZ,300182.SZ,300207.SZ,300212.SZ,300223.SZ,300244.SZ,300257.SZ,300271.SZ,300274.SZ,300285.SZ,300296.SZ,300315.SZ,300316.SZ,300324.SZ,300347.SZ,300357.SZ,300376.SZ,300408.SZ,300413.SZ,300418.SZ,300433.SZ,300459.SZ,300463.SZ,300474.SZ,300482.SZ,300496.SZ,300498.SZ,300529.SZ,300595.SZ,300601.SZ,300618.SZ,300628.SZ,300630.SZ,300676.SZ,300699.SZ,600000.SH,600004.SH,600006.SH,600008.SH,600009.SH,600010.SH,600011.SH,600015.SH,600016.SH,600018.SH,600019.SH,600021.SH,600022.SH,600025.SH,600026.SH,600027.SH,600028.SH,600029.SH,600030.SH,600031.SH,600036.SH,600037.SH,600038.SH,600039.SH,600048.SH,600050.SH,600053.SH,600056.SH,600060.SH,600061.SH,600062.SH,600064.SH,600066.SH,600068.SH,600073.SH,600079.SH,600085.SH,600089.SH,600094.SH,600104.SH,600109.SH,600111.SH,600115.SH,600118.SH,600120.SH,600126.SH,600131.SH,600132.SH,600141.SH,600143.SH,600150.SH,600153.SH,600155.SH,600158.SH,600160.SH,600161.SH,600166.SH,600167.SH,600170.SH,600171.SH,600176.SH,600177.SH,600183.SH,600188.SH,600195.SH,600196.SH,600201.SH,600208.SH,600216.SH,600219.SH,600233.SH,600256.SH,600258.SH,600259.SH,600260.SH,600266.SH,600271.SH,600273.SH,600276.SH,600277.SH,600282.SH,600291.SH,600297.SH,600299.SH,600307.SH,600309.SH,600312.SH,600315.SH,600316.SH,600325.SH,600329.SH,600332.SH,600338.SH,600339.SH,600340.SH,600346.SH,600348.SH,600350.SH,600352.SH,600362.SH,600369.SH,600372.SH,600373.SH,600376.SH,600380.SH,600383.SH,600388.SH,600390.SH,600392.SH,600398.SH,600406.SH,600409.SH,600410.SH,600415.SH,600418.SH,600426.SH,600435.SH,600436.SH,600438.SH,600446.SH,600460.SH,600466.SH,600482.SH,600486.SH,600487.SH,600489.SH,600497.SH,600498.SH,600500.SH,600507.SH,600511.SH,600515.SH,600516.SH,600517.SH,600519.SH,600522.SH,600528.SH,600529.SH,600535.SH,600545.SH,600546.SH,600547.SH,600549.SH,600556.SH,600563.SH,600566.SH,600567.SH,600570.SH,600572.SH,600575.SH,600580.SH,600582.SH,600584.SH,600585.SH,600588.SH,600597.SH,600598.SH,600600.SH,600606.SH,600623.SH,600633.SH,600637.SH,600639.SH,600640.SH,600642.SH,600643.SH,600645.SH,600648.SH,600649.SH,600655.SH,600657.SH,600660.SH,600664.SH,600667.SH,600673.SH,600675.SH,600690.SH,600699.SH,600703.SH,600704.SH,600705.SH,600707.SH,600717.SH,600718.SH,600728.SH,600729.SH,600733.SH,600737.SH,600739.SH,600741.SH,600745.SH,600748.SH,600754.SH,600755.SH,600760.SH,600763.SH,600765.SH,600776.SH,600779.SH,600782.SH,600787.SH,600795.SH,600801.SH,600804.SH,600808.SH,600809.SH,600811.SH,600820.SH,600823.SH,600827.SH,600835.SH,600837.SH,600839.SH,600845.SH,600848.SH,600859.SH,600862.SH,600863.SH,600867.SH,600869.SH,600871.SH,600872.SH,600875.SH,600879.SH,600881.SH,600884.SH,600885.SH,600886.SH,600887.SH,600893.SH,600895.SH,600900.SH,600901.SH,600903.SH,600908.SH,600909.SH,600917.SH,600918.SH,600919.SH,600926.SH,600928.SH,600958.SH,600959.SH,600967.SH,600968.SH,600970.SH,600985.SH,600989.SH,600998.SH,600999.SH,601000.SH,601003.SH,601005.SH,601006.SH,601009.SH,601012.SH,601016.SH,601021.SH,601066.SH,601068.SH,601077.SH,601088.SH,601098.SH,601099.SH,601100.SH,601106.SH,601108.SH,601111.SH,601117.SH,601118.SH,601127.SH,601128.SH,601138.SH,601139.SH,601155.SH,601162.SH,601166.SH,601168.SH,601169.SH,601179.SH,601186.SH,601198.SH,601200.SH,601211.SH,601216.SH,601225.SH,601228.SH,601229.SH,601231.SH,601233.SH,601236.SH,601238.SH,601288.SH,601298.SH,601318.SH,601319.SH,601328.SH,601333.SH,601336.SH,601360.SH,601377.SH,601390.SH,601398.SH,601456.SH,601512.SH,601555.SH,601577.SH,601598.SH,601600.SH,601601.SH,601607.SH,601608.SH,601611.SH,601615.SH,601618.SH,601628.SH,601633.SH,601658.SH,601668.SH,601669.SH,601688.SH,601689.SH,601696.SH,601698.SH,601699.SH,601717.SH,601718.SH,601727.SH,601766.SH,601778.SH,601788.SH,601799.SH,601800.SH,601801.SH,601808.SH,601816.SH,601818.SH,601828.SH,601838.SH,601857.SH,601860.SH,601865.SH,601866.SH,601869.SH,601872.SH,601877.SH,601878.SH,601880.SH,601881.SH,601888.SH,601899.SH,601901.SH,601916.SH,601919.SH,601928.SH,601933.SH,601939.SH,601958.SH,601966.SH,601969.SH,601975.SH,601985.SH,601988.SH,601989.SH,601990.SH,601992.SH,601997.SH,601998.SH,603000.SH,603019.SH,603056.SH,603077.SH,603087.SH,603156.SH,603160.SH,603195.SH,603198.SH,603225.SH,603228.SH,603256.SH,603259.SH,603260.SH,603288.SH,603290.SH,603317.SH,603328.SH,603338.SH,603345.SH,603355.SH,603369.SH,603377.SH,603379.SH,603392.SH,603444.SH,603486.SH,603501.SH,603515.SH,603568.SH,603589.SH,603605.SH,603638.SH,603650.SH,603658.SH,603708.SH,603712.SH,603719.SH,603737.SH,603786.SH,603799.SH,603806.SH,603816.SH,603833.SH,603858.SH,603866.SH,603868.SH,603882.SH,603883.SH,603885.SH,603888.SH,603893.SH,603899.SH,603927.SH,603983.SH,603986.SH,603993.SH,688002.SH,688008.SH,688009.SH,688012.SH,688029.SH,688036.SH,688088.SH,688099.SH,688321.SH", "mkt_freeshares", "2017-01-01", "2019-12-31", "unit=1")